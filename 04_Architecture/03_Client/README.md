# クライアントアプリのアーキテクチャ定義書

本章ではクライアントアプリの処理方式設計にフォーカスした内容を記載する。

## アプリ言語・フレームワークの選定

### 言語

フロントエンド開発なので、JavaScript が開発言語になる。  
Web 版（PC）のみを作成するのみの想定。

### フレームワーク

フレームワークは[React.js](https://ja.reactjs.org/)を利用する想定。

## 静的チェック方式の確定

コードの静的チェックとしては[ESLint](https://eslint.org/)を利用する。  
Eslint は JS で一般的に利用される、静的チェックツールであり、コーディングの規約が適用されているかどうかのチェックをシステム上で実現することが可能になる。  
また、フォーマッター（整形）については[prettier](https://prettier.io/)を利用する。

型定義の確認については[TypeScript](https://www.typescriptlang.org/)を利用する。

## テスト方式の確定

### 単体テスト

テストとしては[jest](https://jestjs.io/ja/)を利用する。  
理由としては、

- React.js のテストとして利用できるため
- バックエンド側のテストツールと平仄を合わせられるため

#### 確認観点

フロントエンドの確認観点として以下のことを実施する。

- 動的項目の表示内容
  - 想定のリソースが変わることで、想定通りに表示値が変わることの確認
- 各イベントの確認
  - 初期表示
  - ボタン押下
  - ファイルアップロード
- 画面遷移の確認
  - ボタン押下などのイベント実施した際に想定通りの画面先に遷移するか（URL の確認）
  - エラー発生時は画面 URL が変わってないか
- API 打鍵の確認
  - ボタン押下などのイベント実施した際に想定通りの API が打鍵されるか。
  - 正常時・エラー発生時に想定通りの文言が表示されるか
  - API 打鍵成功時にリソースが変更されて画面情報が想定通りに変わっているか
- バリデーション内容の確認
  - 入力項目に対するバリデーションがうまく効いているかどうか
  - 各入力内容の時に、ボタンの状態の確認
- カバレッジが 85%を超えていること

#### テスト実施方法

クライアントアプリのテストの方法として以下を実施。

- API はモックとしてテストコードの中で指定。
- 関数の直接実行はしない。
- ユーザの状態は用意されたパターンから選定して使用（Redux を更新）
  - 未登録ユーザ
  - ユーザ情報のみ登録済みユーザ
  - サイト・決済情報を登録済みユーザ
  - サイト複数登録済みユーザ

## ローカル起動の方法

ローカル起動の際には以下のように実施する。

- 認証基盤は Docker を立ち上げる。
- API のモックは Swagger のモックを使用

## バリデーション方式の統一

ここではバリデーションの方式について記載する。  
統一されたバリデーション方式を使用することで、共通的な部品による処理を実現する。

### バリデーションチェックの検知方法

バリデーションのチェックはライブラリとして[react-hook-form](https://react-hook-form.com/)を利用する。  
バリデーションチェックの方法については公式にしたがい、[register](https://react-hook-form.com/api/useform/register)を利用してバリデーションチェックの内容を定義する。

### ユーザへのエラー通知のフォーマット

バリデーションチェックによるエラー通知についてはバリデーションチェックの種類ごとにパターン化する。  
例えば、`max`のバリデーションチェックに引っかかった場合には`〇〇の値については最大maxまでにしてください。`というメッセージを出せるようにする。

パターンごとにどのようなフォーマットを利用するかの一覧はファイルとして外だしして、`messageTemplate.json`として管理する。

## ログ処理方式の統一

クライアント側のログに関しては基本的に、[GA4](https://www.ga4.guide/)で送信する。

### アクセス情報の取得方針

アクセス情報については基本的にデフォルトで取得される項目に従って取得していく。  
デフォルトで取得される情報以外の情報については以下に記載していく。

#### ボタン押下時

ボタン押下がされたことをログで通知します。  
その際に以下の情報を送信します。

- 画面情報（URL）
- ユーザ ID
- ボタン情報（ボタンテキスト）

#### API 打鍵時

API が打鍵されたタイミングでも情報を通知します。  
どのような API 情報を送信してレスポンスが返却されたかについては API-GW 側で取れいているため、送信しない。

あくまでもタイムアウトが発生していないかどうかを検知するためのものである。  
以下の情報を API 打鍵時に送信する。

- リクスト送信時・レスポンス受領時
- API の URL
- API の Method

### エラー時の検知方法

エラーの種類として以下３つのエラーが基本的に存在するためそれぞれに分けて記載する。

- API エラー発生
- JSX レンダリング時のエラー発生
- JS のエラーが発生

#### API エラー

API エラーが発生した際には、ログに送信する情報は以下の通り。

- API の URL
- API のリクエストの Method
- API のレスポンスステータス
- API のレスポンスボディ

#### JSX レンダリング時のエラー

React で実装されているため、JSX レンダリング時のエラーが発生する可能性はある。  
それを検知するために React に備わっている機能である、[Error-Boundary](https://ja.reactjs.org/docs/error-boundaries.html)で内容を検知し、ログに送信する。

#### JS エラーによる検知

JS の構文エラーが発生する可能性もある。  
そのようなエラーが発生した際には[window.onerror](https://qiita.com/grapswiz/items/71f14e73820e352c1fa3)を利用することで検知可能になる。

## データ管理方式の統一

ここではフロンアプリのデータ管理方法について記載する。  
フロントアプリのデータに関してはそれぞれ以下のように役割を分けて管理する。

- Redux : API のデータを管理
- Context : ユーザからの入力値
- localStorage : 永続化させたい情報（トークン系など)
- history の state : 画面間で入力値以外で渡したい情報

### API 打鍵結果によるデータ同期の方法

ここでは API のリソース情報をどのようにして同期するかを記載する。  
API のリソース情報については[システム共通の処理方式](../01_System/README.md#api-のインターフェースの統一)にも記載した通りである。

ルール化されているため、以下のように方針を決めて Redux の情報を更新することが可能。

- API の URL：リソースの種類の確定
- API のメソッド：リソースに対する更新方法の確定

#### GET

GET リクエストの場合にはリソースの取得として、Redux の情報を全て更新する。

#### POST

POST リクエストの場合には、リソースの追加として、Redux にデータを追加する。

#### PUT

PUT リクエストの場合には、リソースの変更として、Redux のデータを更新する。

#### DELETE

DELETE リクエストの場合には、リソースの削除として Redux のデータの削除を実施する。

## ディレクトリ構造

ディレクトリ構造について定義する。  
ディレクトリは基本的にコンポーネントベースの構造とする。  
※この章は実際にプロジェクトを組み立てて行く中で育てる。
